<link rel="import" href="../bower_components/polymer/polymer.html">
<script type="text/javascript" src="../bower_components/leaflet/dist/leaflet.js"></script>

<polymer-element name="remix-map" attributes="latitude longitude zoom">
  <template>
    <link rel="stylesheet" href="../bower_components/leaflet/dist/leaflet.css" />
  <style>
    :host { display: block; }
    :host #map {height:100%; width:100%}
  </style>
  <div id="map"></div>
  <content id="markers" select="*"></content>
  </template>
  <script>
    function loadJSON(path, success, error)
    {
        var xhr = new XMLHttpRequest();
        xhr.onreadystatechange = function()
        {
            if (xhr.readyState === XMLHttpRequest.DONE) {
                if (xhr.status === 200) {
                    if (success)
                        success(JSON.parse(xhr.responseText));
                } else {
                    if (error)
                        error(xhr);
                }
            }
        };
        xhr.open("GET", path, true);
        xhr.send();
    };
    function invertCoord(array) {
       var result = []
       for (var i = 0; i<array.length ;i++)
       {
         var coord = array[i];
         result.push([coord[1], coord[0]]);
       }
       return result;
    };
    function onMouse(event) {
      if (event.type == "click")
      {
         event.target._map.fitBounds(event.target.getBounds(), {animate:true, pan:{duration:1}});
      }
      else if (event.type == "mouseover")
       {
          event.target.setStyle({color:'#0f3'});
       }
       else{
          event.target.setStyle({color:'#03f'});
       }
    };

    Polymer('remix-map', {
      domReady: function() {
        var map = L.map(this.$.map, {
            center: [this.latitude, this.longitude],
            zoom  : this.zoom
          });
        this.map = map;
        // add a default layer if there are no layers defined
    var defaultLayerRequired = true;
    for (var i = 0; i < this.children.length; i++) {
      var e = this.children[i];
      if (e.isLayer && e.isLayer()) {
        defaultLayerRequired = false;
      }
    }
    if (defaultLayerRequired) {
      L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
        attribution: 'Map data &copy; <a href="http://openstreetmap.org">OpenStreetMap</a> contributors, <a href="http://creativecommons.org/licenses/by-sa/2.0/">CC-BY-SA</a>, Imagery &copy; <a href="http://mapbox.com">Mapbox</a>',
        maxZoom: 18
      }).addTo(this.map);
    };
    loadJSON("data/users.json", function(elements) {
            for (var i=0; i < elements.length; i++) {
            var greenIcon = L.icon({
                iconUrl: 'leaflet/dist/images/marker-leaf-green.png',
                shadowUrl: 'leaflet/dist/images/leaf-shadow.png',

                iconSize:     [38, 95], // size of the icon
                shadowSize:   [50, 64], // size of the shadow
                iconAnchor:   [22, 94], // point of the icon which will correspond to marker's location
                shadowAnchor: [4, 62],  // the same for the shadow
                popupAnchor:  [-3, -76] // point from which the popup should open relative to the iconAnchor
            });
             var e = elements[i];
             var marker = L.marker([e.lat, e.lon], {
              icon: greenIcon,
              clickable: true,
              title: e.title,
              alt: e.title
            });
             marker.bindPopup(e.description);
             marker.addTo(map);
           }
          }, function(xhr) { console.error(xhr); });
    loadJSON("data/projects.json", function(elements) {
            for (var i=0; i < elements.length; i++) {
             var e = elements[i];
             var marker = L.marker([e.lat, e.lon], {
              clickable: true,
              title: e.title,
              alt: e.title
            });
             marker.bindPopup(e.description);
             marker.addTo(map);
           }
          }, function(xhr) { console.error(xhr); });
        loadJSON("data/perimetre_de_quartier.json", function(elements) {
            for (var i=0; i < elements.features.length; i++) {
             var e = elements.features[i];
             var marker = L.polygon(invertCoord(e.geometry.coordinates[0]), {
              clickable: true,
              title: e.properties.nom,
              weight :2,
              opacity :1
            });
             marker.bindPopup(e.properties.nom);
             marker.addTo(map);
             marker.on("mouseover mouseout click", onMouse);
           }
          }, function(xhr) { console.error(xhr); });
      }
    });
  </script>
</polymer-element>
